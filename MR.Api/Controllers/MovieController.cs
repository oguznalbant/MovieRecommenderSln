using AutoMapper;
using Hangfire;
using Microsoft.AspNetCore.Mvc;
using MR.Api.Entities;
using MR.Api.Helper;
using MR.Api.Models.Request;
using MR.Api.Models.Response;
using MR.Api.Repositories;
using MR.Api.Services;

namespace MR.Api.Controllers
{
    [Route("api/[controller]")]
    [ApiController]
    public class MovieController : ControllerBase
    {
        private readonly IEmailSender _emailSender;
        private readonly ITMDBService _tmdbService;
        private readonly IMovieRepository _movieRepository;
        private readonly IMapper _mapper;

        public MovieController(IEmailSender emailSender, ITMDBService tmdbService, IMovieRepository movieRepository, IMapper mapper)
        {
            _emailSender = emailSender;
            _tmdbService = tmdbService;
            _movieRepository = movieRepository;
            _mapper = mapper;
        }

        [HttpGet]
        [Route("Get")]
        public async Task<ActionResult<GetMovieResponse>> Get([FromQuery] GetMovieRequest request)
        {
            var movie = await _movieRepository.GetMovie(request.MovieId).ConfigureAwait(false);
            return Ok(movie);
        }

        [HttpGet]
        [Route("GetList")]
        public async Task<ActionResult<GetMovieListResponse>> GetList([FromQuery] GetMovieListRequest request)
        {
            var result = await _movieRepository.GetMovies(request).ConfigureAwait(false);
            var movies = _mapper.Map<IEnumerable<MovieListItem>>(result);

            return Ok(new GetMovieListResponse
            {
                MovieListItems = movies,
                PageNumber = request.PageNumber,
                PageSize = request.PageSize,
                TotalCount = movies.Count(),
                TotalPages = movies.Count() / request.PageSize
            });
        }

        [HttpPost("AddComment")]
        public async Task<ActionResult<bool>> AddCommentMovie([FromBody] AddCommentMovieRequest request)
        {
            await _movieRepository.AddMovieComment(new MovieComment
            {
                Comment = request.Note,
                Email = request.Email,
                MovieId = request.MovieId,
                Star = request.Point
            }).ConfigureAwait(false);

            BackgroundJob.Enqueue(() => UpdateCommentRate(new UpdateCommentRateRequest(request.MovieId)));

            return Ok(true);
        }

        [HttpPost("UpdateCommentRate")]
        [Queue("comment")]
        public async Task<ActionResult<bool>> UpdateCommentRate([FromBody] UpdateCommentRateRequest request)
        {
            var comments = await _movieRepository.GetCommentsByMovieId(request.MovieId).ConfigureAwait(false);

            if (comments != null)
            {
                await _movieRepository.UpdateCommentRateOfMovie(request.MovieId, (decimal)comments.Average(m => m.Star)).ConfigureAwait(false);
            }

            return Ok(true);
        }

        [HttpPost("RecommendMovie")]
        public async Task<ActionResult<bool>> RecommendMovie([FromBody] RecommendMovieRequest request)
        {
            var movie = await _movieRepository.GetMovie(request.MovieId).ConfigureAwait(false);

            //TODO: google başına url ekliyor!
            var movieBasePath = "https://image.tmdb.org/t/p/w600_and_h900_bestv2/";
            string html = string.Format(@"
<html xmlns='http://www.w3.org/1999/xhtml' xmlns:v='urn:schemas-microsoft-com:vml' xmlns:o='urn:schemas-microsoft-com:office:office'><head><!--[if gte mso 9]><xml> <o:OfficeDocumentSettings> <o:AllowPNG/> <o:PixelsPerInch>96</o:PixelsPerInch> </o:OfficeDocumentSettings></xml><![endif]--> <meta http-equiv='Content-Type' content='text/html; charset=UTF-8'> <meta name='viewport' content='width=device-width, initial-scale=1.0'> <meta name='x-apple-disable-message-reformatting'> <meta http-equiv='X-UA-Compatible' content='IE=edge'> <title></title> <style type='text/css'> @media only screen and (min-width: 620px){{.u-row{{width: 600px !important;}}.u-row .u-col{{vertical-align: top;}}.u-row .u-col-29p34{{width: 176.04px !important;}}.u-row .u-col-33p33{{width: 199.98px !important;}}.u-row .u-col-35p33{{width: 211.98px !important;}}.u-row .u-col-100{{width: 600px !important;}}}}@media (max-width: 620px){{.u-row-container{{max-width: 100% !important; padding-left: 0px !important; padding-right: 0px !important;}}.u-row .u-col{{min-width: 320px !important; max-width: 100% !important; display: block !important;}}.u-row{{width: 100% !important;}}.u-col{{width: 100% !important;}}.u-col > div{{margin: 0 auto;}}}}body{{margin: 0; padding: 0;}}table,tr,td{{vertical-align: top; border-collapse: collapse;}}p{{margin: 0;}}.ie-container table,.mso-container table{{table-layout: fixed;}}*{{line-height: inherit;}}a[x-apple-data-detectors='true']{{color: inherit !important; text-decoration: none !important;}}table, td{{color: #000000;}}@media (max-width: 480px){{#u_content_heading_1 .v-container-padding-padding{{padding: 30px 10px 0px !important;}}#u_content_heading_1 .v-font-size{{font-size: 32px !important;}}#u_content_text_6 .v-container-padding-padding{{padding: 10px 15px !important;}}#u_column_7 .v-col-background-color{{background-color: #b11616 !important;}}#u_column_8 .v-col-background-color{{background-color: #c51414 !important;}}#u_column_9 .v-col-background-color{{background-color: #b11616 !important;}}}}</style> <link href='https://fonts.googleapis.com/css?family=Montserrat:400,700&display=swap' rel='stylesheet' type='text/css'><link href='https://fonts.googleapis.com/css?family=Playfair+Display:400,700&display=swap' rel='stylesheet' type='text/css'></head><body class='clean-body u_body' style='margin: 0;padding: 0;-webkit-text-size-adjust: 100%;background-color: #eeeeee;color: #000000'> <table style='border-collapse: collapse;table-layout: fixed;border-spacing: 0;mso-table-lspace: 0pt;mso-table-rspace: 0pt;vertical-align: top;min-width: 320px;Margin: 0 auto;background-color: #eeeeee;width:100%' cellpadding='0' cellspacing='0'> <tbody> <tr style='vertical-align: top'> <td style='word-break: break-word;border-collapse: collapse !important;vertical-align: top'> <div class='u-row-container' style='padding: 0px;background-color: transparent'> <div class='u-row' style='Margin: 0 auto;min-width: 320px;max-width: 600px;overflow-wrap: break-word;word-wrap: break-word;word-break: break-word;background-color: transparent;'> <div style='border-collapse: collapse;display: table;width: 100%;height: 100%;background-color: transparent;'> <div class='u-col u-col-100' style='max-width: 320px;min-width: 600px;display: table-cell;vertical-align: top;'> <div class='v-col-background-color' style='background-color: #000000;height: 100%;width: 100% !important;'> <div style='height: 100%; padding: 0px;border-top: 0px solid transparent;border-left: 0px solid transparent;border-right: 0px solid transparent;border-bottom: 0px solid transparent;'> </div></div></div></div></div></div><div class='u-row-container' style='padding: 0px;background-color: transparent'> <div class='u-row' style='Margin: 0 auto;min-width: 320px;max-width: 600px;overflow-wrap: break-word;word-wrap: break-word;word-break: break-word;background-color: transparent;'> <div style='border-collapse: collapse;display: table;width: 100%;height: 100%;background-color: transparent;'> <div class='u-col u-col-100' style='max-width: 320px;min-width: 600px;display: table-cell;vertical-align: top;'> <div class='v-col-background-color' style='background-color: #000000;height: 100%;width: 100% !important;border-radius: 0px;-webkit-border-radius: 0px; -moz-border-radius: 0px;'> <div style='height: 100%; padding: 0px;border-top: 0px solid transparent;border-left: 0px solid transparent;border-right: 0px solid transparent;border-bottom: 0px solid transparent;border-radius: 0px;-webkit-border-radius: 0px; -moz-border-radius: 0px;'> <table style='font-family:'Montserrat',sans-serif;' role='presentation' cellpadding='0' cellspacing='0' width='100%' border='0'> <tbody> <tr> <td class='v-container-padding-padding' style='overflow-wrap:break-word;word-break:break-word;padding:10px;font-family:'Montserrat',sans-serif;' align='left'> <table width='100%' cellpadding='0' cellspacing='0' border='0'> <tr> <td style='padding-right: 0px;padding-left: 0px;' align='center'> 
<img align='center' border='0' src='{0}{1}' alt='Image' title='Image' style='outline: none;text-decoration: none;-ms-interpolation-mode: bicubic;clear: both;display: inline-block !important;border: none;height: auto;float: none;width: 100%;max-width: 580px;' width='580'/> </td></tr></table> </td></tr></tbody></table> </div></div></div></div></div></div><div class='u-row-container' style='padding: 0px;background-color: transparent'> <div class='u-row' style='Margin: 0 auto;min-width: 320px;max-width: 600px;overflow-wrap: break-word;word-wrap: break-word;word-break: break-word;background-color: transparent;'> <div style='border-collapse: collapse;display: table;width: 100%;height: 100%;background-color: transparent;'> <div class='u-col u-col-100' style='max-width: 320px;min-width: 600px;display: table-cell;vertical-align: top;'> <div class='v-col-background-color' style='background-color: #000000;height: 100%;width: 100% !important;border-radius: 0px;-webkit-border-radius: 0px; -moz-border-radius: 0px;'> <div style='height: 100%; padding: 0px;border-top: 0px solid transparent;border-left: 0px solid transparent;border-right: 0px solid transparent;border-bottom: 0px solid transparent;border-radius: 0px;-webkit-border-radius: 0px; -moz-border-radius: 0px;'> <table style='font-family:'Montserrat',sans-serif;' role='presentation' cellpadding='0' cellspacing='0' width='100%' border='0'> <tbody> <tr> <td class='v-container-padding-padding' style='overflow-wrap:break-word;word-break:break-word;padding:0px;font-family:'Montserrat',sans-serif;' align='left'> <table width='100%' cellpadding='0' cellspacing='0' border='0'> <tr> <td style='padding-right: 0px;padding-left: 0px;' align='center'> <img align='center' border='0' src='images/image-1.png' alt='image' title='image' style='outline: none;text-decoration: none;-ms-interpolation-mode: bicubic;clear: both;display: inline-block !important;border: none;height: auto;float: none;width: 100%;max-width: 600px;' width='600'/> </td></tr></table> </td></tr></tbody></table> </div></div></div></div></div></div><div class='u-row-container' style='padding: 0px;background-color: transparent'> <div class='u-row' style='Margin: 0 auto;min-width: 320px;max-width: 600px;overflow-wrap: break-word;word-wrap: break-word;word-break: break-word;background-color: transparent;'> <div style='border-collapse: collapse;display: table;width: 100%;height: 100%;background-color: transparent;'> <div class='u-col u-col-100' style='max-width: 320px;min-width: 600px;display: table-cell;vertical-align: top;'> <div class='v-col-background-color' style='background-color: #c51414;height: 100%;width: 100% !important;border-radius: 0px;-webkit-border-radius: 0px; -moz-border-radius: 0px;'> <div style='height: 100%; padding: 0px;border-top: 0px solid transparent;border-left: 0px solid transparent;border-right: 0px solid transparent;border-bottom: 0px solid transparent;border-radius: 0px;-webkit-border-radius: 0px; -moz-border-radius: 0px;'> <table id='u_content_heading_1' style='font-family:'Montserrat',sans-serif;' role='presentation' cellpadding='0' cellspacing='0' width='100%' border='0'> <tbody> <tr> <td class='v-container-padding-padding' style='overflow-wrap:break-word;word-break:break-word;padding:30px 10px 0px;font-family:'Montserrat',sans-serif;' align='left'> <h1 class='v-font-size' style='margin: 0px; color: #ffffff; line-height: 140%; text-align: center; word-wrap: break-word; font-weight: normal; font-family: 'Playfair Display',serif; font-size: 35px;'><div>
<strong>{2}:{3}</strong></div></h1> </td></tr></tbody></table><table id='u_content_text_6' style='font-family:'Montserrat',sans-serif;' role='presentation' cellpadding='0' cellspacing='0' width='100%' border='0'> <tbody> <tr> <td class='v-container-padding-padding' style='overflow-wrap:break-word;word-break:break-word;padding:10px 80px;font-family:'Montserrat',sans-serif;' align='left'> <div style='color: #ffffff; line-height: 140%; text-align: center; word-wrap: break-word;'> <p style='font-size: 14px; line-height: 140%;'>
{4}</p></div></td></tr></tbody></table> </div></div></div></div></div></div><div class='u-row-container' style='padding: 0px;background-color: transparent'> <div class='u-row' style='Margin: 0 auto;min-width: 320px;max-width: 600px;overflow-wrap: break-word;word-wrap: break-word;word-break: break-word;background-color: transparent;'> <div style='border-collapse: collapse;display: table;width: 100%;height: 100%;background-color: transparent;'> <div class='u-col u-col-35p33' style='max-width: 320px;min-width: 211.98px;display: table-cell;vertical-align: top;'> <div class='v-col-background-color' style='background-color: #c51414;height: 100%;width: 100% !important;border-radius: 0px;-webkit-border-radius: 0px; -moz-border-radius: 0px;'> <div style='height: 100%; padding: 0px;border-top: 0px solid transparent;border-left: 0px solid transparent;border-right: 0px solid transparent;border-bottom: 0px solid transparent;border-radius: 0px;-webkit-border-radius: 0px; -moz-border-radius: 0px;'> </div></div></div><div class='u-col u-col-29p34' style='max-width: 320px;min-width: 176.04px;display: table-cell;vertical-align: top;'> <div class='v-col-background-color' style='background-color: #c51414;height: 100%;width: 100% !important;border-radius: 0px;-webkit-border-radius: 0px; -moz-border-radius: 0px;'> <div style='height: 100%; padding: 0px;border-top: 0px solid transparent;border-left: 0px solid transparent;border-right: 0px solid transparent;border-bottom: 0px solid transparent;border-radius: 0px;-webkit-border-radius: 0px; -moz-border-radius: 0px;'> </div></div></div><div class='u-col u-col-35p33' style='max-width: 320px;min-width: 211.98px;display: table-cell;vertical-align: top;'> <div class='v-col-background-color' style='background-color: #c51414;height: 100%;width: 100% !important;border-radius: 0px;-webkit-border-radius: 0px; -moz-border-radius: 0px;'> <div style='height: 100%; padding: 0px;border-top: 0px solid transparent;border-left: 0px solid transparent;border-right: 0px solid transparent;border-bottom: 0px solid transparent;border-radius: 0px;-webkit-border-radius: 0px; -moz-border-radius: 0px;'> </div></div></div></div></div></div><div class='u-row-container' style='padding: 0px;background-color: transparent'> <div class='u-row' style='Margin: 0 auto;min-width: 320px;max-width: 600px;overflow-wrap: break-word;word-wrap: break-word;word-break: break-word;background-color: transparent;'> <div style='border-collapse: collapse;display: table;width: 100%;height: 100%;background-color: transparent;'> <div id='u_column_7' class='u-col u-col-33p33' style='max-width: 320px;min-width: 200px;display: table-cell;vertical-align: top;'> <div class='v-col-background-color' style='background-color: #c51414;height: 100%;width: 100% !important;border-radius: 0px;-webkit-border-radius: 0px; -moz-border-radius: 0px;'> <div style='height: 100%; padding: 0px;border-top: 0px solid transparent;border-left: 0px solid transparent;border-right: 0px solid transparent;border-bottom: 0px solid transparent;border-radius: 0px;-webkit-border-radius: 0px; -moz-border-radius: 0px;'> </div></div></div><div id='u_column_8' class='u-col u-col-33p33' style='max-width: 320px;min-width: 200px;display: table-cell;vertical-align: top;'> <div class='v-col-background-color' style='background-color: #c51414;height: 100%;width: 100% !important;border-radius: 0px;-webkit-border-radius: 0px; -moz-border-radius: 0px;'> <div style='height: 100%; padding: 0px;border-top: 0px solid transparent;border-left: 0px solid transparent;border-right: 0px solid transparent;border-bottom: 0px solid transparent;border-radius: 0px;-webkit-border-radius: 0px; -moz-border-radius: 0px;'> </div></div></div><div id='u_column_9' class='u-col u-col-33p33' style='max-width: 320px;min-width: 200px;display: table-cell;vertical-align: top;'> <div class='v-col-background-color' style='background-color: #c51414;height: 100%;width: 100% !important;border-radius: 0px;-webkit-border-radius: 0px; -moz-border-radius: 0px;'> <div style='height: 100%; padding: 0px;border-top: 0px solid transparent;border-left: 0px solid transparent;border-right: 0px solid transparent;border-bottom: 0px solid transparent;border-radius: 0px;-webkit-border-radius: 0px; -moz-border-radius: 0px;'> </div></div></div></div></div></div><div class='u-row-container' style='padding: 0px;background-color: transparent'> <div class='u-row' style='Margin: 0 auto;min-width: 320px;max-width: 600px;overflow-wrap: break-word;word-wrap: break-word;word-break: break-word;background-color: transparent;'> <div style='border-collapse: collapse;display: table;width: 100%;height: 100%;background-color: transparent;'> <div class='u-col u-col-100' style='max-width: 320px;min-width: 600px;display: table-cell;vertical-align: top;'> <div class='v-col-background-color' style='background-color: #c51414;height: 100%;width: 100% !important;border-radius: 0px;-webkit-border-radius: 0px; -moz-border-radius: 0px;'> <div style='height: 100%; padding: 0px;border-top: 0px solid transparent;border-left: 0px solid transparent;border-right: 0px solid transparent;border-bottom: 0px solid transparent;border-radius: 0px;-webkit-border-radius: 0px; -moz-border-radius: 0px;'> <table style='font-family:'Montserrat',sans-serif;' role='presentation' cellpadding='0' cellspacing='0' width='100%' border='0'> <tbody> <tr> <td class='v-container-padding-padding' style='overflow-wrap:break-word;word-break:break-word;padding:0px;font-family:'Montserrat',sans-serif;' align='left'> <table width='100%' cellpadding='0' cellspacing='0' border='0'> <tr> <td style='padding-right: 0px;padding-left: 0px;' align='center'> <img align='center' border='0' src='images/image-2.png' alt='image' title='image' style='outline: none;text-decoration: none;-ms-interpolation-mode: bicubic;clear: both;display: inline-block !important;border: none;height: auto;float: none;width: 100%;max-width: 600px;' width='600'/> </td></tr></table> </td></tr></tbody></table> </div></div></div></div></div></div><div class='u-row-container' style='padding: 0px;background-color: transparent'> <div class='u-row' style='Margin: 0 auto;min-width: 320px;max-width: 600px;overflow-wrap: break-word;word-wrap: break-word;word-break: break-word;background-color: transparent;'> <div style='border-collapse: collapse;display: table;width: 100%;height: 100%;background-color: transparent;'> <div class='u-col u-col-100' style='max-width: 320px;min-width: 600px;display: table-cell;vertical-align: top;'> <div class='v-col-background-color' style='background-color: #000000;height: 100%;width: 100% !important;border-radius: 0px;-webkit-border-radius: 0px; -moz-border-radius: 0px;'> <div style='height: 100%; padding: 0px;border-top: 0px solid transparent;border-left: 0px solid transparent;border-right: 0px solid transparent;border-bottom: 0px solid transparent;border-radius: 0px;-webkit-border-radius: 0px; -moz-border-radius: 0px;'> </div></div></div></div></div></div><div class='u-row-container' style='padding: 0px;background-color: transparent'> <div class='u-row' style='Margin: 0 auto;min-width: 320px;max-width: 600px;overflow-wrap: break-word;word-wrap: break-word;word-break: break-word;background-color: transparent;'> <div style='border-collapse: collapse;display: table;width: 100%;height: 100%;background-color: transparent;'> <div class='u-col u-col-100' style='max-width: 320px;min-width: 600px;display: table-cell;vertical-align: top;'> <div class='v-col-background-color' style='background-color: #c51414;height: 100%;width: 100% !important;border-radius: 0px;-webkit-border-radius: 0px; -moz-border-radius: 0px;'> <div style='height: 100%; padding: 0px;border-top: 0px solid transparent;border-left: 0px solid transparent;border-right: 0px solid transparent;border-bottom: 0px solid transparent;border-radius: 0px;-webkit-border-radius: 0px; -moz-border-radius: 0px;'> </div></div></div></div></div></div></td></tr></tbody> </table> </body></html>
", movieBasePath, "https://image.tmdb.org/t/p/w600_and_h900_bestv2/", "Film Öneriniz Var", movie.Name, movie.Overview);
            _emailSender.SendEmail(request.ToMailAddress, "Film Önerisi", html);
            return Ok(true);
        }
    }
}
